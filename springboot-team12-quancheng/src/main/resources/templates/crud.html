
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>vue进行CURD操作</title>
    <style type="text/css">
        [v-cloak] {
            display: none
        }
        table {
            border: 1px solid #ccc;
            padding: 0;
            border-collapse: collapse;
            table-layout: fixed;
            margin-top: 10px;
            width: 100%;
        }
        table td,
        table th {
            height: 30px;
            border: 1px solid #ccc;
            background: #fff;
            font-size: 15px;
            padding: 3px 3px 3px 8px;
        }
        table th:first-child {
            width: 30px;
        }
        .container,
        .st {
            width: 1000px;
            margin: 10px auto 0;
            font-size: 13px;
            font-family: 'Microsoft YaHei'
        }
        .container .search {
            font-size: 15px;
            padding: 4px;
        }
        .container .add {
            padding: 5px 15px;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 6;
            background: rgba(0, 0, 0, 0.7);
        }
        .overlay td:first-child {
            width: 66px;
        }
        .overlay .con {
            position: absolute;
            width: 420px;
            min-height: 300px;
            background: #fff;
            left: 50%;
            top: 50%;
            -webkit-transform: translate3d(-50%, -50%, 0);
            transform: translate3d(-50%, -50%, 0);
            /*margin-top: -150px;*/
            padding: 20px;
        }
    </style>
    <style type="text/css">
			     	/*分页*/
			#box{margin:0 auto;width:500px}
			.page-bar{
			margin:40px auto;
			margin-top: 150px;

			}
			ul,li{
			margin: 0px;
			padding: 0px;
			}
			li{
			list-style: none
			}
			.page-bar li:first-child>a {
			margin-left: 0px
			}
			.page-bar a{
			border: 1px solid #ddd;
			text-decoration: none;
			position: relative;
			float: left;
			padding: 6px 12px;
			margin-left: -1px;
			line-height: 1.42857143;
			color: #5D6062;
			cursor: pointer;
			margin-right: 20px;
			}
			.page-bar a:hover{
			background-color: #eee;
			}
			.page-bar a.banclick{
			cursor:not-allowed;
			}
			.page-bar .active a{
			color: #fff;
			cursor: default;
			background-color: #E96463;
			border-color: #E96463;
			}
			.page-bar i{
			font-style:normal;
			color: #d44950;
			margin: 0px 4px;
			font-size: 12px;
			}
     </style>
</head>
<body>
<div class="st">
    <h1>vue实现对数据的增删改查(CURD)</h1>
</div>
<div class="container" id="app">
    <div>
        <input type="text" placeholder="search" @input="search" list="cars" class="search">
        <datalist id="cars">
            <option v-for="item in searchlist" :value="item"></option>
        </datalist>
        <input type="button" class="add" @click="add" value="新增">
    </div>
    <div>
        <table>
            <tr>
                <th>id</th>
                <th>用户名</th>
                <th>邮箱</th>
                <th>性别</th>
                <th>省份</th>
                <th>爱好</th>
                <th>操作</th>
            </tr>
            <tr v-cloak v-for="(item) of slist">
                <td>{{item.id}}</td>
                <td>{{item.username}}</td>
                <td>{{item.email}}</td>
                <td>{{item.sex}}</td>
                <td>{{item.province}}</td>
                <td>{{item.hobby.join(' | ')}}</td>
                <td><a href="javascript:;" @click="showOverlay(item.id)">修改</a> | <a href="javascript:;" @click="comfire(item.id)">删除</a></td>
            </tr>
        </table>
    </div>
    <model :list='selectedlist' :isactive="isActive" v-cloak @change="changeOverlay" @modify="modify"></model>
</div>
<!--分页-->
<div class="page-bar" id="box">
    <ul>
        <li v-if="cur>1"><a v-on:click="cur--,pageClick()">上一页</a></li>
        <!--<li v-if="cur==1"><a class="banclick">上一页</a></li>-->
        <li v-for="index in indexs" v-bind:class="{ 'active': cur == index}">
            <a v-on:click="btnClick(index)">{{ index }}</a>
        </li>
        <li v-if="cur!=all"><a v-on:click="cur++,pageClick()">下一页</a></li>
        <!--<li v-if="cur == all"><a class="banclick">下一页</a></li>-->
        <li><a>共<i>{{all}}</i>页</a></li>
    </ul>
</div>
</body>
<script type="text/javascript" src="./vue.js"></script>
<script type="text/javascript" src="jquery-3.4.1.js"></script>
<script type="text/javascript">
    Vue.component('model', {
        props: ['list', 'isactive'],
        template: '<div class="overlay" v-show="isactive">\n' +
            '                        <div class="con">\n' +
            '                        <h2 class="title">新增 | 修改</h2>\n' +
            '                        <div class="content">\n' +
            '                        <table>\n' +
            '                        <tr>\n' +
            '                        <td>用户名</td>\n' +
            '                        <td><input type="text" v-model="modifylist.username"></td>\n' +
            '                        </tr>\n' +
            '                        <tr>\n' +
            '                        <td>邮箱</td>\n' +
            '                        <td><input type="text" v-model="modifylist.email"></td>\n' +
            '                        </tr>\n' +
            '                        <tr>\n' +
            '                        <td>性别</td>\n' +
            '                        <td>\n' +
            '                        <label><input type="radio" name="sex" value="男" v-model="modifylist.sex">男</label>\n' +
            '                        <label><input type="radio" name="sex" value="女" v-model="modifylist.sex">女</label>\n' +
            '                        <label><input type="radio" name="sex" value="未知" v-model="modifylist.sex">未知</label>\n' +
            '                        </td>\n' +
            '                        </tr>\n' +
            '                        <tr>\n' +
            '                        <td>省份</td>\n' +
            '                        <td>\n' +
            '                        <select name="" id="" v-model="modifylist.province">\n' +
            '                        <option value="北京市">北京市</option>\n' +
            '                        <option value="河北省">河北省</option>\n' +
            '                        <option value="河南省">河南省</option>\n' +
            '                        <option value="重庆市">重庆市</option>\n' +
            '                        <option value="广东省">广东省</option>\n' +
            '                        <option value="辽宁省">辽宁省</option>\n' +
            '                        </select>\n' +
            '                        </td>\n' +
            '                        </tr>\n' +
            '                        <tr>\n' +
            '                        <td>爱好</td>\n' +
            '                        <td>\n' +
            '                        <label><input type="checkbox" v-model="modifylist.hobby" value="篮球">篮球</label>\n' +
            '                        <label><input type="checkbox" v-model="modifylist.hobby" value="读书">读书</label>\n' +
            '                        <label><input type="checkbox" v-model="modifylist.hobby" value="插画">插画</label>\n' +
            '                        <label><input type="checkbox" v-model="modifylist.hobby" value="编程">编程</label>\n' +
            '                        <label><input type="checkbox" v-model="modifylist.hobby" value="弹琴">弹琴</label>\n' +
            '                        </td>\n' +
            '                        </tr>\n' +
            '                        </table>\n' +
            '                        <p>\n' +
            '                        <input type="button" @click="changeActive" value="取消">\n' +
            '                        <input type="button" @click="modify" value="保存">\n' +
            '                        </p>\n' +
            '                        </div>\n' +
            '                        </div>\n' +
            '                    </div>',
        computed: {
            modifylist() {
                return this.list;
            }
        },
        methods: {
            changeActive() {
                this.$emit('change');
            },
            modify() {
                this.$emit('modify', this.modifylist);
            }
        }
    });
    var app = new Vue({
        el: "#app",
        data: {
            isActive: false,
            selected: -1,
            selectedlist: {},
            slist: [],
            searchlist: [],
            list: []
        },
        created() {
            this.findAll();
        },
        methods: {
            //查询全部用户
            findAll: function() {
                let that = this;
                $.getJSON("/user",function (data) {
                    for (var i=0;i<data.length;i++){
                        data[i].hobby = data[i].hobby.split(",");
                    }
                    that.setList(data);
                    that.setSlist(that.list);
                })
            },
            // 修改数据
            showOverlay(index) {
                var id = parseInt(index);
                let that = this;
                $.ajax({
                    url:"/user/"+id,
                    method:'get',
                    data:{"id":id},
                    success:function (data) {
                        if(data!=null) {
                            data.hobby = data.hobby.split(",");
                            that.selectedlist=JSON.parse(JSON.stringify(data));
                        }else{
                            alert("查找失败");
                        }
                    }
                });
                this.changeOverlay();
            },
            // 点击保存按钮
            modify(arr) {
                let myarr = arr;
                var that = this;
                if (this.selected > -1) {
                    myarr.hobby = myarr.hobby.join(",")
                    var user = JSON.stringify(myarr);
                    $.ajax({
                        url:"/user",
                        method:'put',
                        data:user,
                        dataType:'json',
                        contentType:'application/json',
                        success:function (data) {
                            if(data!=null){

                                that.findAll();
                            }else{
                                alert("更新失败");
                            }
                        }
                    });
                    this.selected = -1;
                } else {
                    myarr.hobby = myarr.hobby.join(",")
                    var user = JSON.stringify(myarr);
                    $.ajax({
                        url:"/user",
                        method:'post',
                        data:user,
                        contentType:'application/json',
                        success:function (data) {
                            if(data == 'OK') {
                                that.findAll();
                            }else{
                                alert("新增失败");
                            }
                        }
                    });
                }
                this.changeOverlay();
            },
            add: function () {
                this.selectedlist = {
                    username: '',
                    email: '',
                    sex: '男',
                    province: '北京市',
                    hobby: []
                };
                this.isActive = true;
            },
            // delete list in index location
            comfire(id){
              if(window.confirm("确定要删除吗？")){
                  this.del(id);
              }else{
                  return false;
              }
            },
            del(index) {
                var id = parseInt(index);
               let that = this;
                $.ajax({
                    url:"/user",
                    method:'delete',
                    data:{"id":id},
                    success:function (data) {
                        if(data == 'OK'){
                            that.findAll();
                        }else{
                            alert("失败");
                        }
                    }
                });
            },
            changeOverlay() {
                this.isActive = !this.isActive;
            },
            // 获取需要渲染到页面中的数据
            setSlist(arr) {
                this.slist = JSON.parse(JSON.stringify(arr));
            },

            setList(arr){
                this.list = JSON.parse(JSON.stringify(arr));
            },
            // 搜索
            search(e) {
                var v = e.target.value,
                    self = this;
                self.searchlist = [];
                if (v) {
                    var ss = [];
                    // 过滤需要的数据
                    this.list.forEach(function (item) {
                        if (item.username.indexOf(v) > -1) {
                            if (self.searchlist.indexOf(item.username) == -1) {
                                self.searchlist.push(item.username);
                            }
                            ss.push(item);
                        } else if (item.email.indexOf(v) > -1) {
                            if (self.searchlist.indexOf(item.email) == -1) {
                                self.searchlist.push(item.email);
                            }
                            ss.push(item);
                        }
                    });
                    this.setSlist(ss); // 将过滤后的数据给了slist
                } else {
                    // 没有搜索内容，则展示全部数据
                    this.setSlist(this.list);
                }
            }
        },
        watch: {
        }
    })
</script>
</html>